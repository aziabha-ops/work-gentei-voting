<!-- /index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>WORK GENTEI 2026 Voting</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: '"Inter", "Segoe UI", system-ui, sans-serif';
      background: linear-gradient(135deg, #0a1128 0%, #1a2847 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container { max-width: 900px; width: 100%; }
    .header { text-align: center; margin-bottom: 40px; color: white; }
    .header h1 { font-size: 3.5rem; font-weight: 900; margin-bottom: 5px; letter-spacing: -1px; }
    .header h1 span { color: #dc143c; }
    .header-line {
      height: 3px;
      background: linear-gradient(90deg, #dc143c, #00d4ff);
      width: 300px;
      margin: 15px auto;
      border-radius: 2px;
    }
    .header p { font-size: 1rem; color: #00d4ff; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }

    .card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(0,212,255,0.15);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }
    .screen { display: none; }
    .screen.active { display: block; }

    .role-screen h2 { font-size: 2rem; color: white; margin-bottom: 30px; font-weight: 900; }
    .role-buttons { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .role-btn {
      flex: 1;
      min-width: 150px;
      padding: 30px;
      border: 2px solid rgba(0,212,255,0.2);
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      color: #999;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .role-btn:hover { border-color: #00d4ff; background: rgba(0,212,255,0.05); color: #00d4ff; }
    .role-btn.selected { border-color: #dc143c; background: rgba(220,20,60,0.1); color: #dc143c; }

    .name-input-section { margin-bottom: 30px; }
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #00d4ff;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px 15px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(0,212,255,0.2);
      border-radius: 6px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s ease;
      margin-bottom: 15px;
    }
    input[type="text"]:focus { outline: none; border-color: #00d4ff; background: rgba(0,212,255,0.05); }
    input::placeholder { color: rgba(255,255,255,0.3); }

    .btn-start {
      width: 100%;
      padding: 16px;
      background: linear-gradient(90deg, #dc143c, #ff1744);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn-start:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(220,20,60,0.4); }
    .btn-start:disabled { opacity: 0.5; cursor: not-allowed; }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0,212,255,0.2);
      border-radius: 10px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #dc143c, #00d4ff); transition: width 0.3s ease; }

    .category-title { font-size: 1.8rem; font-weight: 900; color: white; margin-bottom: 10px; }
    .category-subtitle { font-size: 0.9rem; color: #999; margin-bottom: 20px; }

    .criteria {
      background: rgba(0,0,0,0.3);
      border-left: 4px solid #00d4ff;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 30px;
      color: #cbd5e1;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .car-selector {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 20px;
      margin-bottom: 25px;
      align-items: start;
    }
    .car-image {
      width: 100%;
      height: 280px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(0,212,255,0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      order: 2;
    }
    .car-image img { width: 100%; height: 100%; object-fit: contain; }

    .select-wrapper { order: 1; }
    select {
      width: 100%;
      padding: 12px 15px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(0,212,255,0.2);
      border-radius: 6px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    select:focus { outline: none; border-color: #00d4ff; background: rgba(0,212,255,0.05); }
    select option { background: #1a2847; color: white; }

    .selection-confirm {
      display: none;
      background: rgba(0,212,255,0.08);
      border: 1px solid rgba(0,212,255,0.2);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      order: 3;
      grid-column: 1 / -1;
    }
    .selection-confirm.show { display: block; }
    .selection-confirm-text {
      color: #999;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .selection-confirm-value {
      color: #00d4ff;
      font-weight: 900;
      font-size: 1.1rem;
      font-family: monospace;
      word-break: break-all;
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: space-between;
      margin-top: 35px;
      flex-wrap: wrap;
    }
    button {
      padding: 14px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-back {
      background: rgba(0,0,0,0.2);
      color: #999;
      flex: 0 1 auto;
      border: 1px solid rgba(0,212,255,0.1);
    }
    .btn-back:hover { background: rgba(0,212,255,0.08); color: #00d4ff; }
    .btn-back:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-next {
      background: linear-gradient(90deg, #dc143c, #ff1744);
      color: white;
      flex: 1;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 150px;
    }
    .btn-next:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(220,20,60,0.4); }
    .btn-next:disabled { opacity: 0.5; cursor: not-allowed; }

    .voter-info { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 12px; }
    .error { color: #dc143c; font-size: 0.85rem; margin-top: 5px; }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
      padding: 10px 12px;
      border: 1px solid rgba(0,212,255,0.15);
      border-radius: 10px;
      background: rgba(0,0,0,0.18);
      color: #cbd5e1;
      font-size: 0.9rem;
    }
    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,212,255,0.2);
      color: #00d4ff;
      font-weight: 700;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .card { padding: 25px; }
      .header h1 { font-size: 2.5rem; }
      .category-title { font-size: 1.4rem; }
      .car-selector { grid-template-columns: 1fr; }
      .car-image { order: 1; height: 200px; }
      .select-wrapper { order: 2; }
      .selection-confirm { order: 3; grid-column: 1; }
      .btn-next, .btn-back { padding: 12px 16px; font-size: 0.95rem; }
      .status-bar { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>WORK <span>GENTEI</span></h1>
      <div class="header-line"></div>
      <p>2026 Voting</p>
    </div>

    <div class="card">
      <div class="screen active" id="roleScreen">
        <div class="role-screen">
          <h2>Select Your Role</h2>

          <div class="role-buttons">
            <button class="role-btn" onclick="selectRole(event,'entrant')">Work Gentei Entrant</button>
            <button class="role-btn" onclick="selectRole(event,'spectator')">Spectator</button>
          </div>

          <div class="name-input-section">
            <label for="voterName">Your Name *</label>
            <input type="text" id="voterName" placeholder="e.g. John Smith" />
            <span class="error" id="nameError"></span>
          </div>

          <button class="btn-start" onclick="startVoting()">Begin Voting</button>
        </div>
      </div>

      <div class="screen" id="votingScreen">
        <div class="status-bar">
          <div id="voterInfo" class="voter-info"></div>
          <div id="connectivityPill" class="status-pill">Checking‚Ä¶</div>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div id="votingContainer"></div>
      </div>
    </div>
  </div>

  <script>
    /**
     * CONFIG
     */
    const CLOUDINARY_CLOUD = 'dbee9zuk5';
    const CLOUDINARY_BASE = `https://res.cloudinary.com/${CLOUDINARY_CLOUD}/image/upload/`;

    // ‚úÖ Your current Apps Script Web App URL:
    const GOOGLE_APPS_SCRIPT_URL =
      'https://script.google.com/macros/s/AKfycbyfmdk4pYvXzh33pBABdzTkUgIv99yVwT3oBqzw49PqfMySI99sxvWHvw7-pO5Cfkyo/exec';

    /**
     * DATA
     */
    const carData = [
      { num: 1, make: 'BMW', model: 'E92 M3', cloudId: '1_BMW__E92_M3_adavnb' },
      { num: 2, make: 'BMW', model: '850i', cloudId: '2_BMW_850i_eskpwh' },
      { num: 3, make: 'BMW', model: 'E30 325is', cloudId: '3_BMW_E30_325is_lw4ssz' },
      { num: 4, make: 'BMW', model: 'E39 535i', cloudId: '4_BMW_E39_535i_pqedig' },
      { num: 5, make: 'BMW', model: 'E46 M3', cloudId: '5_BMW_E46_M3_eqxkiy' },
      { num: 6, make: 'Mercedes', model: 'C63', cloudId: '6_Merc_C63_q9yrwt' },
      { num: 7, make: 'BMW', model: 'E92 M3', cloudId: '7_BMW_E92_M3_xe8lcx' },
      { num: 8, make: 'BMW', model: 'E30 325i', cloudId: '8_BMW_E30_325i_zoesz5' },
      { num: 9, make: 'Volkswagen', model: 'CITI', cloudId: '9_VW_CITI_llxb6w' },
      { num: 10, make: 'Volkswagen', model: 'Golf mk2', cloudId: '10_VW_Golf_mk2_bb5cuf' },
      { num: 11, make: 'BMW', model: 'M Coupe', cloudId: '11_BMW_M_Coupe_qvgmth' },
      { num: 12, make: 'BMW', model: 'F80 M3', cloudId: '12_BMW_F80_M3_tkdnbz' },
      { num: 13, make: 'VW', model: 'Polo 8 GTI', cloudId: '13_VW_Polo_8_GTI_djzk3q' },
      { num: 14, make: 'Volkswagen', model: 'Golf 7R', cloudId: '14_VW_Golf_7R_i5qqcj' },
      { num: 15, make: 'BMW', model: 'E30 325is', cloudId: '15_BMW_E30_325is_hdzecd' },
      { num: 16, make: 'Volkswagen', model: 'Citirox', cloudId: '16_VW_Citirox_lmorrd' },
      { num: 17, make: 'Volkswagen', model: 'Golf 8R', cloudId: '17_VW_Golf_8R_vpfdjo' },
      { num: 18, make: 'BMW', model: 'E36 cab', cloudId: '18_BMW_E36_325i_cab_bqozot' },
      { num: 19, make: 'Volkswagen', model: 'Golf 4, 2 door', cloudId: '19_VW_Golf_4_2dr_ms0uk0' },
      { num: 20, make: 'BMW', model: 'E30 M3', cloudId: '20_BMW_E30_M3_wulyfx' },
      { num: 21, make: 'BMW', model: 'E92 M3', cloudId: '21_BMW_E92_M3_rpblnu' },
      { num: 22, make: 'Audi', model: 'S3', cloudId: '22_Audi_S3_lquabn' },
      { num: 23, make: 'BMW', model: 'E30 Bauer', cloudId: '23_BMW_E30_Bauer_r1zauv' },
      { num: 24, make: 'BMW', model: 'E30 325i', cloudId: '24_BMW_E30_325i_jtsnay' },
      { num: 25, make: 'Porsche', model: '997 turbo', cloudId: '25_Porsche_997_turbo_al8j50' },
      { num: 26, make: 'Audi', model: 'RS3', cloudId: '26_Audi_RS3_vk2ohx' },
      { num: 27, make: 'BMW', model: 'E30 325is', cloudId: '27_BMW_E30_325is_rjbecu' },
      { num: 28, make: 'BMW', model: 'M2 Comp', cloudId: '28_BMW_M2_Comp_foqt0i' },
      { num: 29, make: 'BMW', model: 'E46 M3', cloudId: '29_BMW_E46_M3_c31ype' },
      { num: 30, make: 'BMW', model: 'E92 M3', cloudId: '30_BMW_E92_M3_pbrliq' },
      { num: 31, make: 'Toyota', model: 'GT86', cloudId: '31_Toyota_GT86_y2wksp' },
      { num: 32, make: 'BMW', model: 'F80 M3', cloudId: '32_BMW_F80_M3_olu2it' },
      { num: 33, make: 'Volkswagen', model: 'Citi velocity 1.4i', cloudId: '33_VW_Citi_velocity_1.4i_hxensr' },
      { num: 34, make: 'BMW', model: '325is', cloudId: '34_BMW_325is_r4ovpo' },
      { num: 35, make: 'BMW', model: 'E30 Bauer', cloudId: '35_BMW_E30_Bauer_rsmvll' },
      { num: 36, make: 'BMW', model: 'E92 M3', cloudId: '36_BMW_E92_M3_cy01rm' },
      { num: 37, make: 'BMW', model: 'M3 Comp', cloudId: '37_BMW_M3_Comp_xsnelc' }
    ];

    /**
     * CATEGORIES
     * type:
     * - "ranked": needs N unique picks
     * - "single": needs 1 pick
     */
    const entrantCategories = [
      {
        id: 'showcase',
        type: 'ranked',
        ranks: 4,
        title: 'WORK GENTEI ‚Äì SHOWCASE CHAMPION',
        subtitle: 'Rank 1st‚Äì4th (unique picks)',
        criteria:
          'Select your 1st, 2nd, 3rd, and 4th place vehicles. Each rank must be a different vehicle.',
        icon: 'üèÜ'
      },
      {
        id: 'og_wheel',
        type: 'single',
        title: 'WORK GENTEI ‚Äì BEST OG WORK WHEEL',
        subtitle: 'Category Award',
        criteria: 'Best original/classic WORK wheel specification. Period-correct, iconic, or historically significant.',
        icon: 'üîÑ'
      },
      {
        id: 'fitment',
        type: 'single',
        title: 'WORK GENTEI ‚Äì BEST WHEEL FITMENT',
        subtitle: 'Category Award',
        criteria: 'Outstanding offset, camber, tuck, and stance execution. Technical precision in wheel fitment.',
        icon: '‚öôÔ∏è'
      },
      {
        id: 'phat',
        type: 'single',
        title: 'WORK GENTEI ‚Äì THE PHAT AWARD',
        subtitle: 'Category Award',
        criteria: 'The most visually stunning, aggressive, or statement-making build. Pure wow factor.',
        icon: 'üí•'
      },
      {
        id: 'rare',
        type: 'single',
        title: 'WORK GENTEI ‚Äì MOST RARE WORK WHEEL',
        subtitle: 'Category Award',
        criteria: 'Rarest, most exclusive, or hardest-to-find WORK wheel specification.',
        icon: 'üíé'
      }
    ];

    const spectatorCategories = [
      {
        id: 'crowd_fav',
        type: 'ranked',
        ranks: 2,
        title: 'WORK GENTEI ‚Äì CROWD FAVORITE',
        subtitle: 'Rank 1st‚Äì2nd (unique picks)',
        criteria: 'Select your 1st and 2nd favorite vehicles. Each rank must be a different vehicle.',
        icon: '‚ù§Ô∏è'
      }
    ];

    /**
     * STATE
     */
    let selectedRole = null;
    let voterName = '';
    let currentCategory = 0;
    let categories = [];
    let votes = {}; // { showcase: [n1,n2,n3,n4], crowd_fav:[n1,n2], og_wheel: n, ... }

    /**
     * UI HELPERS
     */
    function selectRole(evt, role) {
      selectedRole = role;
      document.querySelectorAll('.role-btn').forEach((btn) => btn.classList.remove('selected'));
      if (evt && evt.target) evt.target.classList.add('selected');
    }

    function startVoting() {
      document.getElementById('nameError').textContent = '';

      voterName = document.getElementById('voterName').value.trim();
      if (!voterName) {
        document.getElementById('nameError').textContent = 'Name required';
        return;
      }

      if (selectedRole === 'entrant') categories = entrantCategories;
      else if (selectedRole === 'spectator') categories = spectatorCategories;
      else { alert('Please select a role'); return; }

      document.getElementById('roleScreen').classList.remove('active');
      document.getElementById('votingScreen').classList.add('active');

      checkConnectivity();
      renderCategory();
    }

    function renderCategory() {
      const cat = categories[currentCategory];
      const container = document.getElementById('votingContainer');
      const roleLabel = selectedRole === 'entrant' ? 'Entrant' : 'Spectator';
      document.getElementById('voterInfo').textContent = `${voterName} (${roleLabel})`;
      document.getElementById('progressFill').style.width = `${((currentCategory + 1) / categories.length) * 100}%`;

      const headerHtml = `
        <div style="display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
          <span style="font-size:3rem;">${cat.icon}</span>
          <div style="flex:1;">
            <h2 class="category-title">${cat.title}</h2>
            <p class="category-subtitle">${cat.subtitle}</p>
          </div>
        </div>
        <div class="criteria">${cat.criteria}</div>
      `;

      const buttonsHtml = `
        <div class="button-group">
          <button class="btn-back" onclick="previousCategory()" ${currentCategory === 0 ? 'disabled' : ''}>‚Üê Back</button>
          <button class="btn-next" id="nextBtn" onclick="nextCategory()" disabled>
            ${currentCategory === categories.length - 1 ? 'Submit All Votes' : 'Next ‚Üí'}
          </button>
        </div>
      `;

      container.innerHTML = headerHtml + (cat.type === 'ranked' ? renderRankedHtml_(cat) : renderSingleHtml_(cat)) + buttonsHtml;

      if (cat.type === 'ranked') {
        restoreRanked_(cat);
        validateRanked_(cat);
      } else {
        restoreSingle_(cat);
        validateSingle_(cat);
      }
    }

    function renderSingleHtml_(cat) {
      return `
        <div class="car-selector">
          <div class="select-wrapper">
            <label for="carSelect">Select a Vehicle</label>
            <select id="carSelect" onchange="updateSingleSelection()">
              <option value="">-- Choose --</option>
              ${carData.map((car, idx) => `<option value="${idx}">Car ${car.num} | ${car.make} ${car.model}</option>`).join('')}
            </select>
            <div class="error" id="selectionError"></div>
          </div>
          <div class="car-image" id="carImageContainer"></div>
          <div id="confirm" class="selection-confirm"></div>
        </div>
      `;
    }

    function renderRankedHtml_(cat) {
      const rankLabels = cat.ranks === 4
        ? ['1st Place', '2nd Place', '3rd Place', '4th Place']
        : ['1st Place', '2nd Place'];

      const rows = rankLabels.map((label, i) => `
        <div style="margin-bottom:14px;">
          <label for="rankSelect_${i}">${label}</label>
          <select id="rankSelect_${i}" onchange="updateRankedSelection(${i})">
            <option value="">-- Choose --</option>
            ${carData.map((car, idx) => `<option value="${idx}">Car ${car.num} | ${car.make} ${car.model}</option>`).join('')}
          </select>
        </div>
      `).join('');

      return `
        <div class="car-selector">
          <div class="select-wrapper">
            ${rows}
            <div class="error" id="rankError"></div>
          </div>
          <div class="car-image" id="carImageContainer"></div>
          <div id="confirm" class="selection-confirm"></div>
        </div>
      `;
    }

    function restoreSingle_(cat) {
      const saved = votes[cat.id];
      if (typeof saved === 'number') {
        const idx = carData.findIndex(c => c.num === saved);
        if (idx >= 0) {
          document.getElementById('carSelect').value = String(idx);
          updateSingleSelection();
        }
      }
    }

    function restoreRanked_(cat) {
      const saved = votes[cat.id];
      if (Array.isArray(saved)) {
        saved.forEach((carNum, rankIndex) => {
          const idx = carData.findIndex(c => c.num === carNum);
          if (idx >= 0) {
            const sel = document.getElementById(`rankSelect_${rankIndex}`);
            if (sel) sel.value = String(idx);
          }
        });
        updateRankedPreview_(cat);
      }
    }

    /**
     * SINGLE
     */
    function updateSingleSelection() {
      const select = document.getElementById('carSelect');
      const confirm = document.getElementById('confirm');
      const nextBtn = document.getElementById('nextBtn');
      const carImageContainer = document.getElementById('carImageContainer');
      const errorEl = document.getElementById('selectionError');

      errorEl.textContent = '';

      if (select.value) {
        const carIdx = parseInt(select.value, 10);
        const car = carData[carIdx];

        votes[categories[currentCategory].id] = car.num;

        confirm.innerHTML = `
          <div class="selection-confirm-text">Selected</div>
          <div class="selection-confirm-value">Car ${car.num} | ${car.make} ${car.model}</div>
        `;
        confirm.classList.add('show');

        if (car.cloudId) {
          const imageUrl = CLOUDINARY_BASE + car.cloudId;
          carImageContainer.innerHTML = `<img src="${imageUrl}" alt="Car ${car.num}" onerror="this.parentElement.innerHTML='';">`;
        } else {
          carImageContainer.innerHTML = '';
        }

        nextBtn.disabled = false;
      } else {
        delete votes[categories[currentCategory].id];
        confirm.classList.remove('show');
        carImageContainer.innerHTML = '';
        nextBtn.disabled = true;
      }
    }

    function validateSingle_(cat) {
      const nextBtn = document.getElementById('nextBtn');
      nextBtn.disabled = !(typeof votes[cat.id] === 'number');
    }

    /**
     * RANKED
     */
    function updateRankedSelection(changedRank) {
      const cat = categories[currentCategory];
      const rankError = document.getElementById('rankError');
      rankError.textContent = '';

      const selections = readRankSelections_(cat);

      // Enforce uniqueness
      const seen = new Set();
      for (let i = 0; i < selections.length; i++) {
        const v = selections[i];
        if (!v) continue;
        if (seen.has(v)) {
          // Clear the changed one (most intuitive)
          const sel = document.getElementById(`rankSelect_${changedRank}`);
          if (sel) sel.value = '';
          rankError.textContent = 'Each rank must be a different vehicle.';
          break;
        }
        seen.add(v);
      }

      const cleaned = readRankSelections_(cat).map((idx) => idx ? carData[idx].num : null);
      votes[cat.id] = cleaned;

      updateRankedPreview_(cat);
      validateRanked_(cat);
    }

    function readRankSelections_(cat) {
      const out = [];
      for (let i = 0; i < cat.ranks; i++) {
        const sel = document.getElementById(`rankSelect_${i}`);
        const val = sel ? sel.value : '';
        out.push(val ? parseInt(val, 10) : null);
      }
      return out;
    }

    function validateRanked_(cat) {
      const nextBtn = document.getElementById('nextBtn');
      const saved = votes[cat.id];

      if (!Array.isArray(saved) || saved.length !== cat.ranks) {
        nextBtn.disabled = true;
        return;
      }

      const filled = saved.every((n) => typeof n === 'number' && n > 0);
      if (!filled) { nextBtn.disabled = true; return; }

      const unique = new Set(saved).size === saved.length;
      nextBtn.disabled = !unique;
    }

    function updateRankedPreview_(cat) {
      const confirm = document.getElementById('confirm');
      const carImageContainer = document.getElementById('carImageContainer');

      const saved = votes[cat.id];
      if (!Array.isArray(saved) || saved.length !== cat.ranks) {
        confirm.classList.remove('show');
        carImageContainer.innerHTML = '';
        return;
      }

      const items = saved.map((carNum, i) => {
        if (!carNum) return null;
        const car = carData.find(c => c.num === carNum);
        if (!car) return null;
        const label = (cat.ranks === 4 ? ['1st','2nd','3rd','4th'] : ['1st','2nd'])[i];
        return { label, car };
      }).filter(Boolean);

      if (!items.length) {
        confirm.classList.remove('show');
        carImageContainer.innerHTML = '';
        return;
      }

      // Show 1st place image as the preview
      const first = items[0]?.car;
      if (first?.cloudId) {
        const imageUrl = CLOUDINARY_BASE + first.cloudId;
        carImageContainer.innerHTML = `<img src="${imageUrl}" alt="Car ${first.num}" onerror="this.parentElement.innerHTML='';">`;
      } else {
        carImageContainer.innerHTML = '';
      }

      confirm.innerHTML = `
        <div class="selection-confirm-text">Selected</div>
        <div class="selection-confirm-value">
          ${items.map(x => `${x.label}: Car ${x.car.num} | ${x.car.make} ${x.car.model}`).join('<br/>')}
        </div>
      `;
      confirm.classList.add('show');
    }

    /**
     * NAV
     */
    function nextCategory() {
      if (currentCategory < categories.length - 1) {
        currentCategory++;
        renderCategory();
        return;
      }

      const roleLabel = selectedRole === 'entrant' ? 'Entrant' : 'Spectator';
      const voteData = buildVotePayload_(roleLabel);

      submitVotesToGoogle(voteData);

      alert(`All votes submitted!\n\nVoter: ${voterName}\nRole: ${roleLabel}\n\nThank you for voting!`);
      location.reload();
    }

    function previousCategory() {
      if (currentCategory > 0) {
        currentCategory--;
        renderCategory();
      }
    }

    /**
     * PAYLOAD (matches your sheet columns A‚ÜíM)
     */
    function buildVotePayload_(roleLabel) {
      const payloadVotes = {
        // Ranked showcase
        showcase_1: null,
        showcase_2: null,
        showcase_3: null,
        showcase_4: null,

        // Singles
        og_wheel: null,
        fitment: null,
        phat: null,
        rare: null,

        // Ranked crowd favorite
        crowd_fav_1: null,
        crowd_fav_2: null
      };

      // Map state into payloadVotes
      if (Array.isArray(votes.showcase)) {
        payloadVotes.showcase_1 = votes.showcase[0] ?? null;
        payloadVotes.showcase_2 = votes.showcase[1] ?? null;
        payloadVotes.showcase_3 = votes.showcase[2] ?? null;
        payloadVotes.showcase_4 = votes.showcase[3] ?? null;
      }
      if (Array.isArray(votes.crowd_fav)) {
        payloadVotes.crowd_fav_1 = votes.crowd_fav[0] ?? null;
        payloadVotes.crowd_fav_2 = votes.crowd_fav[1] ?? null;
      }

      payloadVotes.og_wheel = typeof votes.og_wheel === 'number' ? votes.og_wheel : null;
      payloadVotes.fitment = typeof votes.fitment === 'number' ? votes.fitment : null;
      payloadVotes.phat = typeof votes.phat === 'number' ? votes.phat : null;
      payloadVotes.rare = typeof votes.rare === 'number' ? votes.rare : null;

      return {
        voter: voterName,
        role: roleLabel,
        timestamp: new Date().toISOString(),
        votes: payloadVotes
      };
    }

    /**
     * SUBMIT
     * no-cors = reliable POST, but browser won't expose response.
     * We give best-effort UX (network error/timeout).
     */
    function submitVotesToGoogle(voteData) {
      const url = (GOOGLE_APPS_SCRIPT_URL || '').trim();
      if (!url) {
        console.warn('Google Apps Script URL missing; logging to console:', voteData);
        console.log(JSON.stringify(voteData, null, 2));
        return;
      }

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 8000);

      fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(voteData),
        signal: controller.signal
      }).catch((e) => {
        console.error('Submit error:', e);
        alert('Submission may have failed. Please try again or check connectivity.');
      }).finally(() => clearTimeout(timeout));
    }

    /**
     * HEALTH CHECK (Action a)
     * If /exec is reachable, we mark "Online".
     * This uses no-cors; we can‚Äôt read the JSON, but a fetch resolve strongly suggests reachable.
     */
    function checkConnectivity() {
      const pill = document.getElementById('connectivityPill');
      const url = (GOOGLE_APPS_SCRIPT_URL || '').trim();
      if (!url) {
        pill.textContent = 'Offline';
        return;
      }

      pill.textContent = 'Checking‚Ä¶';

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 4000);

      fetch(url, { method: 'GET', mode: 'no-cors', signal: controller.signal })
        .then(() => { pill.textContent = 'Online'; })
        .catch(() => { pill.textContent = 'Offline'; })
        .finally(() => clearTimeout(timeout));
    }
  </script>
</body>
</html>


/* -------------------------------------------------------------
   Apps Script: Code.gs  (paste into your Apps Script project)
   - Action a: doGet health check
   - Action b: ranked voting columns A‚ÜíM
-------------------------------------------------------------- */

/**
 * Code.gs
 * Writes incoming votes to your Google Sheet.
 */
const SPREADSHEET_ID = '1f-xuq01rrcofyrK1FAVqz71mYclsKegZavV-FXAzxlk';
const SHEET_NAME = 'Votes';

function doGet() {
  return ContentService
    .createTextOutput(JSON.stringify({ ok: true, message: 'WORK GENTEI endpoint is live' }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const raw = e?.postData?.contents ?? '';
    if (!raw) throw new Error('Empty request body');
    const data = JSON.parse(raw);

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME) || ss.getSheets()[0];

    const v = data.votes || {};

    // Sheet columns (A‚ÜíM):
    // A Timestamp
    // B Voter Name
    // C Role
    // D Showcase Champion (1st)
    // E Best OG Work Wheel
    // F Best Wheel Fitment
    // G The PHAT Award
    // H Most Rare Work Wheel
    // I Crowd Favorite (1st)
    // J Showcase 2nd Place
    // K Showcase 3rd Place
    // L Showcase 4th Place
    // M Crowd Favorite 2nd
    const row = [
      data.timestamp ? new Date(data.timestamp) : new Date(),
      String(data.voter || ''),
      String(data.role || ''),

      v.showcase_1 ?? '',
      v.og_wheel ?? '',
      v.fitment ?? '',
      v.phat ?? '',
      v.rare ?? '',
      v.crowd_fav_1 ?? '',

      v.showcase_2 ?? '',
      v.showcase_3 ?? '',
      v.showcase_4 ?? '',
      v.crowd_fav_2 ?? ''
    ];

    sheet.appendRow(row);

    return ContentService
      .createTextOutput(JSON.stringify({ status: 'success' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    console.error(err);
    return ContentService
      .createTextOutput(JSON.stringify({ status: 'error', message: String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
